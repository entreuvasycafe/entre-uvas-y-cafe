<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin - Entre Uvas y Café</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container mt-5">
    <h1 class="text-center mb-4">Panel de Administración</h1>

    <!-- Login -->
    <div id="login-section" class="card mx-auto p-4 shadow-sm" style="max-width: 400px;">
      <form id="login-form">
        <h2 class="mb-3">Iniciar sesión</h2>
        <div class="mb-3">
          <input type="email" class="form-control" id="email" placeholder="Correo" required />
        </div>
        <div class="mb-3">
          <input type="password" class="form-control" id="password" placeholder="Contraseña" required />
        </div>
        <button type="submit" class="btn btn-primary w-100">Entrar</button>
      </form>
    </div>

    <!-- Panel admin -->
    <div id="panel-admin" class="mt-5" style="display: none;">
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h2 class="mb-4">Agregar nuevo producto</h2>
          <form id="form-producto" enctype="multipart/form-data">
            <div class="mb-3">
              <input type="text" class="form-control" id="titulo" placeholder="Título" required />
            </div>
            <div class="mb-3">
              <input type="file" class="form-control" id="imagen" accept="image/*" required />
            </div>
            <div class="mb-3">
              <textarea class="form-control" id="descripcion" placeholder="Descripción" required></textarea>
            </div>
            <div class="mb-3">
                <img id="imagen-preview" src="" alt="Imagen previa" style="max-width: 100%; display: none;">
              </div>
            <div class="mb-3">
              <input type="number" class="form-control" id="precio" placeholder="Precio" required />
            </div>
            <button type="submit" class="btn btn-success">Enviar</button>
          </form>
          
        </div>
      </div>

      <div class="mb-3">
        <h2>Lista de productos</h2>
        <div id="lista-productos" class="row gy-3">
            
        </div>
      </div>
      
      <button id="cerrar-sesion" class="btn btn-danger">Cerrar sesión</button>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">

    // -------------------- Importaciones Firebase --------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";
  
    // -------------------- Configuración Firebase --------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBM2fFPK3Fb5UK-PbWIYdP-SpFZug0mt-0",
      authDomain: "pruebaentreuvasycafe.firebaseapp.com",
      projectId: "pruebaentreuvasycafe",
      storageBucket: "pruebaentreuvasycafe.firebasestorage.app",
      messagingSenderId: "971782771779",
      appId: "1:971782771779:web:cd0eb94abdbe9cece3f0f6",
      measurementId: "G-GFFYS8EW70"
    };
  
    // -------------------- Inicialización de Firebase --------------------
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
  
    // -------------------- Elementos del DOM --------------------
    const lista = document.getElementById("lista-productos");
    const loginForm = document.getElementById("login-form");
    const panelAdmin = document.getElementById("panel-admin");
    const form = document.getElementById('form-producto');
  
    // -------------------- Cargar productos desde Firestore --------------------
    async function cargarProductos() {
      lista.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "productos"));
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const col = document.createElement("div");
        col.className = "col-md-4";
        col.innerHTML = `
  <div class="card h-100 shadow-sm" data-id="${docSnap.id}">
    <img src="${data.imagen}" class="card-img-top imagen-preview" alt="${data.titulo}">
    <div class="card-body">
      <h5 class="card-title">
        <input type="text" class="form-control" value="${data.titulo}" disabled />
      </h5>
      <p class="card-text">
        <textarea class="form-control" disabled>${data.descripcion}</textarea>
      </p>
      <p class="card-text fw-bold">
        <input type="number" class="form-control" value="${data.precio}" disabled />
      </p>

      <!-- Input de imagen oculto -->
      <input type="file" class="form-control imagen-input mb-2" style="display:none;" accept="image/*" />

      <button class="btn btn-outline-danger btn-sm me-2" onclick="eliminarProducto('${docSnap.id}')"><i class="fas fa-trash"></i> Eliminar</button>
      <button class="btn btn-outline-primary btn-sm" onclick="editarProducto('${docSnap.id}', '${data.titulo}', '${data.imagen}', '${data.descripcion}', '${data.precio}')"><i class="fas fa-edit"></i> Editar</button>
      <button class="btn btn-outline-success btn-sm" style="display:none;" onclick="guardarProducto('${docSnap.id}')"><i class="fas fa-save"></i> Guardar</button>
    </div>
  </div>
`;
        lista.appendChild(col);
      });
    }
  
    // -------------------- Habilitar edición de un producto --------------------
    window.editarProducto = (id, titulo, imagen, descripcion, precio) => {
  const card = document.querySelector(`.card[data-id='${id}']`);
  const inputs = card.querySelectorAll("input, textarea");
  const saveButton = card.querySelector("button.btn-outline-success");

  inputs.forEach(input => input.disabled = false);
  card.querySelector(".imagen-input").style.display = "block"; // mostrar input de imagen
  saveButton.style.display = "inline-block";
  card.querySelector("button.btn-outline-primary").style.display = "none";
};
  
    // -------------------- Guardar cambios editados de un producto --------------------
    window.guardarProducto = async (id) => {
      const card = document.querySelector(`.card[data-id='${id}']`);
      const inputs = card.querySelectorAll("input, textarea");
      const titulo = inputs[0].value;
      const descripcion = inputs[1].value;
      const precio = parseInt(inputs[2].value);
      const imagen = card.querySelector("img").src;
  
      const updatedProduct = {
        titulo,
        descripcion,
        precio,
        imagen
      };
  
      try {
        const refDoc = doc(db, "productos", id);
        await updateDoc(refDoc, updatedProduct);
        alert("✅ Producto actualizado");
        inputs.forEach(input => input.disabled = true);
        card.querySelector("button.btn-outline-success").style.display = "none";
        card.querySelector("button.btn-outline-primary").style.display = "inline-block";
        cargarProductos();
      } catch (error) {
        console.error("❌ Error al guardar el producto: ", error);
        alert("Error al guardar el producto");
      }
    };
  
    // -------------------- Eliminar un producto --------------------
    window.eliminarProducto = async (id) => {
      const confirmar = confirm("¿Estás seguro de que deseas eliminar este producto?");
      if (confirmar) {
        try {
          const refDoc = doc(db, "productos", id);
          await deleteDoc(refDoc);
          cargarProductos();
          alert("✅ Producto eliminado exitosamente");
        } catch (error) {
          console.error("❌ Error al eliminar el producto: ", error);
          alert("Error al eliminar el producto");
        }
      }
    };
  
    // -------------------- Agregar un nuevo producto con imagen --------------------
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
  
      const titulo = document.getElementById('titulo').value;
      const imagenFile = document.getElementById('imagen').files[0];
      const descripcion = document.getElementById('descripcion').value;
      const precio = parseInt(document.getElementById('precio').value);
  
      if (!imagenFile) {
        alert("Debes seleccionar una imagen.");
        return;
      }
  
      try {
        let imageUrl = '';
  
        if (imagenFile) {
          const storageRef = ref(storage, `imagenes/${Date.now()}-${imagenFile.name}`);
          await uploadBytes(storageRef, imagenFile);
          imageUrl = await getDownloadURL(storageRef);
        }
  
        const nuevoProducto = {
          titulo,
          imagen: imageUrl,
          descripcion,
          precio
        };
  
        await addDoc(collection(db, "productos"), nuevoProducto);
        alert("✅ Producto agregado");
        form.reset();
        cargarProductos();
      } catch (error) {
        console.error("❌ Error al guardar el producto: ", error);
        alert("Error al guardar producto");
      }
    });
  
    // -------------------- Login del usuario --------------------
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
  
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          console.log("✅ Sesión iniciada");
        })
        .catch((error) => {
          alert("❌ Error de login: " + error.message);
        });
    });
  
    // -------------------- Cerrar sesión --------------------
    document.getElementById("cerrar-sesion").addEventListener("click", () => {
      signOut(auth);
    });
  
    // -------------------- Verifica si el usuario está autenticado --------------------
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.parentElement.style.display = "none";
        panelAdmin.style.display = "block";
        cargarProductos();
      } else {
        loginForm.parentElement.style.display = "block";
        panelAdmin.style.display = "none";
      }
    });
  
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
