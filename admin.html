<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin - Entre Uvas y Café</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container mt-5">
    <h1 class="text-center mb-4">Panel de Administración</h1>

    <!-- Login -->
    <div id="login-section" class="card mx-auto p-4 shadow-sm" style="max-width: 400px;">
      <form id="login-form">
        <img src="/assets/img/logo-footer.png" alt="" style="max-width: 100%; height: 220px; object-fit: contain; display: block; margin: 0 auto;">
        <h2 class="mb-3 text-center">Iniciar sesión</h2>
        <div class="mb-3">
          <input type="email" class="form-control" id="email" placeholder="Correo" required />
        </div>
        <div class="mb-3">
          <input type="password" class="form-control" id="password" placeholder="Contraseña" required />
        </div>
        <button type="submit" class="btn btn-primary w-100">Entrar</button>
      </form>
    </div>

    

    <!-- Panel admin -->
    <div id="panel-admin" class="mt-5" style="display: none;">

      <div class="mb-3">
        <h5>Seleccionar Categoría</h5>
        <div class="d-flex flex-wrap gap-2 mb-2">
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Tortas">Tortas</button>
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Postres">Postres</button>
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Tartaletas">Tartaletas</button>
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Quiches">Quiches</button>
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Empanadas">Empanadas</button>
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Te en hoja">Té en hoja</button>
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Cafe especialidad">Café especialidad</button>
          <button type="button" class="btn btn-outline-primary categoria-btn" data-categoria="Otros">Otros</button>
        </div>
        <input type="hidden" id="categoria" required>
      <button id="cerrar-sesion" class="btn btn-danger">Cerrar sesión</button>
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h2 class="mb-4">Agregar nuevo producto</h2>
          <form id="form-producto" enctype="multipart/form-data">

                      <!-- NUEVO: Campo de categoría -->
           <div class="mb-3">
            <select class="form-select" id="categoria" required>
            <option selected disabled value="">Elige una categoría</option>
            <option value="Tortas">Tortas</option>
            <option value="Postres">Postres</option>
            <option value="Tartaletas">Tartaletas</option>
            <option value="Café">Café</option>
             <option value="Otros">Otros</option>
            </select>
           </div>
            <div class="mb-3">
              <input type="text" class="form-control" id="titulo" placeholder="Título" required />
            </div>
            <div class="mb-3">
              <input type="file" class="form-control" id="imagen" accept="image/*" required />
            </div>
            <div class="mb-3">
              <textarea class="form-control" id="descripcion" placeholder="Descripción" required></textarea>
            </div>
            <div class="mb-3">
                <img id="imagen-preview" src="" alt="Imagen previa" style="max-width: 100%; display: none;">
              </div>

      
            <div class="mb-3">
              <input type="number" class="form-control" id="precio" placeholder="Precio" required />
            </div>
            <button type="submit" class="btn btn-success">Enviar</button>
          </form>
          
        </div>
      </div>

      <div class="mb-3">
    
        <h2>Lista de productos</h2>
        <div id="lista-productos" class="row">
            
        </div>
      </div>
      
      <div id="productos-contenedor"  class="row col-md-8 ">
        <!-- Los productos filtrados se mostrarán aquí -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">

    // -------------------- Importaciones Firebase --------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";
    
  
    // -------------------- Configuración Firebase --------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBM2fFPK3Fb5UK-PbWIYdP-SpFZug0mt-0",
      authDomain: "pruebaentreuvasycafe.firebaseapp.com",
      projectId: "pruebaentreuvasycafe",
      storageBucket: "pruebaentreuvasycafe.firebasestorage.app",
      messagingSenderId: "971782771779",
      appId: "1:971782771779:web:cd0eb94abdbe9cece3f0f6",
      measurementId: "G-GFFYS8EW70"
    };
  
    // -------------------- Inicialización de Firebase --------------------
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const auth = getAuth(app);
    const storage = getStorage(app);
   

    // -------------------- Selección de Categoría --------------------
// -------------------- Selección de Categoría --------------------
// Obtener los botones de categoría y el campo oculto para la categoría seleccionada
const categoriaInput = document.getElementById('categoria');
const categoriaButtons = document.querySelectorAll('.categoria-btn');

// Función para manejar la selección de categorías
categoriaButtons.forEach(button => {
  button.addEventListener('click', () => {
    const categoriaSeleccionada = button.getAttribute('data-categoria');
    
    // Establecer la categoría seleccionada en el campo oculto
    categoriaInput.value = categoriaSeleccionada;
    
    // Activar el botón seleccionado
    categoriaButtons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    
    // Filtrar y mostrar productos según la categoría seleccionada
    mostrarProductosPorCategoria(categoriaSeleccionada);
  });
});

// Función para mostrar productos por categoría desde Firestore
async function mostrarProductosPorCategoria(categoria) {
  try {
    // Obtener los productos de Firestore
    const productosSnapshot = await getDocs(collection(db, "productos"));
    const productos = productosSnapshot.docs.map(doc => ({
      ...doc.data(),
      id: doc.id
    }));

    // Filtrar los productos que coinciden con la categoría seleccionada
    const productosFiltrados = productos.filter(producto => producto.categoria === categoria);

    // Limpiar productos actuales en la interfaz
    const productosContenedor = document.getElementById('productos-contenedor');
    productosContenedor.innerHTML = ''; // Limpiar contenedor antes de agregar los nuevos productos

    // Mostrar los productos filtrados en la interfaz
    if (productosFiltrados.length > 0) {
      productosFiltrados.forEach((producto) => {
        const col = document.createElement("div");
        col.className = "col-md-4";
        col.innerHTML = `
          <div class="card h-100 shadow-sm" data-id="${producto.id}">
            <img src="${producto.imagen}" class="card-img-top imagen-preview" alt="${producto.titulo}">
            <div class="card-body">
              <input type="text" class="form-control mb-2 titulo-input" value="${producto.titulo}" disabled />
              <textarea class="form-control mb-2 descripcion-input" disabled>${producto.descripcion}</textarea>
              <input type="number" class="form-control mb-2 precio-input" value="${producto.precio}" disabled />
              
              <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-warning btn-editar">Editar</button>
                <button class="btn btn-sm btn-success btn-guardar" style="display:none;">Guardar</button>
                <button class="btn btn-sm btn-danger btn-eliminar">Eliminar</button>
              </div>
            </div>
          </div>
        `;
        productosContenedor.appendChild(col);

        // -------------------- Botones de cada producto --------------------
        const card = col.querySelector(".card");
        const tituloInput = card.querySelector(".titulo-input");
        const descripcionInput = card.querySelector(".descripcion-input");
        const precioInput = card.querySelector(".precio-input");

        const btnEditar = card.querySelector(".btn-editar");
        const btnGuardar = card.querySelector(".btn-guardar");
        const btnEliminar = card.querySelector(".btn-eliminar");

        // EDITAR
        btnEditar.addEventListener("click", () => {
          tituloInput.disabled = false;
          descripcionInput.disabled = false;
          precioInput.disabled = false;
          btnGuardar.style.display = "inline-block";
          btnEditar.style.display = "none";
        });

        // GUARDAR
        btnGuardar.addEventListener("click", async () => {
          const nuevoTitulo = tituloInput.value;
          const nuevaDescripcion = descripcionInput.value;
          const nuevoPrecio = parseInt(precioInput.value);

          const productoRef = doc(db, "productos", producto.id);
          await updateDoc(productoRef, {
            titulo: nuevoTitulo,
            descripcion: nuevaDescripcion,
            precio: nuevoPrecio,
          });

          tituloInput.disabled = true;
          descripcionInput.disabled = true;
          precioInput.disabled = true;
          btnGuardar.style.display = "none";
          btnEditar.style.display = "inline-block";
          alert("✅ Producto actualizado");
        });

        // ELIMINAR
        btnEliminar.addEventListener("click", async () => {
          const confirmacion = confirm("¿Estás seguro de que deseas eliminar este producto?");
          if (confirmacion) {
            await deleteDoc(doc(db, "productos", producto.id));
            alert("🗑️ Producto eliminado");
            mostrarProductosPorCategoria(categoria); // recargar la lista con la misma categoría
          }
        });
      });
    } else {
      productosContenedor.innerHTML = '<p>No se encontraron productos en esta categoría.</p>';
    }

  } catch (error) {
    console.error("Error al obtener productos de Firestore:", error);
    alert("Error al obtener productos.");
  }
}

// Llamada inicial para mostrar productos por defecto o una categoría por defecto
mostrarProductosPorCategoria('Postres'); // Cambia según la categoría predeterminada si es necesario

  
    // -------------------- Elementos del DOM --------------------
    const lista = document.getElementById("lista-productos");
    const loginForm = document.getElementById("login-form");
    const panelAdmin = document.getElementById("panel-admin");
    const form = document.getElementById('form-producto');

  
    // -------------------- Agregar un nuevo producto con imagen --------------------
    form.addEventListener("submit", async (e) => {
  e.preventDefault();
  console.log("🟡 Formulario de producto enviado");

  const titulo = document.getElementById('titulo').value;
  const imagenFile = document.getElementById('imagen').files[0];
  const descripcion = document.getElementById('descripcion').value;
  const precio = parseInt(document.getElementById('precio').value);
  const categoria = document.getElementById('categoria').value;  // Obtener la categoría seleccionada

  console.log("📋 Valores del formulario:");
  console.log("Título:", titulo);
  console.log("Descripción:", descripcion);
  console.log("Precio:", precio);
  console.log("Categoría:", categoria);  // Mostrar categoría en consola
  console.log("Archivo seleccionado:", imagenFile);

  if (!imagenFile) {
    alert("Debes seleccionar una imagen.");
    return;
  }

  if (!categoria) {
    alert("Debes seleccionar una categoría.");
    return;
  }

  try {
    const timestamp = Date.now();
    const storageRef = ref(storage, `imagenes/${timestamp}-${imagenFile.name}`);
    console.log("📤 Subiendo imagen a Firebase Storage:", storageRef.fullPath);

    await uploadBytes(storageRef, imagenFile);
    console.log("✅ Imagen subida correctamente");

    const imageUrl = await getDownloadURL(storageRef);
    console.log("🌐 URL de la imagen:", imageUrl);

    const nuevoProducto = {
      titulo,
      imagen: imageUrl,
      descripcion,
      precio,
      categoria // Añadir la categoría al producto
    };

    console.log("📝 Enviando producto a Firestore:", nuevoProducto);

    await addDoc(collection(db, "productos"), nuevoProducto);
    alert("✅ Producto agregado");

    form.reset();
    document.getElementById("imagen-preview").style.display = "none";
    mostrarProductosPorCategoria(categoria);
  } catch (error) {
    console.error("❌ Error al guardar el producto:", error);
    alert("Error al guardar producto: " + error.message);
  }
});
  
    // -------------------- Login del usuario --------------------
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
  
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          console.log("✅ Sesión iniciada");
        })
        .catch((error) => {
          alert("❌ Error de login: " + error.message);
        });
    });
  
    // -------------------- Cerrar sesión --------------------
    document.getElementById("cerrar-sesion").addEventListener("click", () => {
      signOut(auth);
    });
  
    // -------------------- Verifica si el usuario está autenticado --------------------
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.parentElement.style.display = "none";
        panelAdmin.style.display = "block";
        cargarProductos();
      } else {
        loginForm.parentElement.style.display = "block";
        panelAdmin.style.display = "none";
      }
    });
  
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
